#!/usr/bin/ansible-playbook -i localhost,
<<<<<<< HEAD

=======
>>>>>>> Update build scripts
---
- name: Create mogilefs rpm from source
  hosts: all
  gather_facts: False
  connection: local
  vars:
    - mogilefs_server_version: 2.72
    - build_dir: /vagrant/rpmbuild
    - perl_cpan_urls:
      - name: BSD-Resource-1.2907
        url:  http://search.cpan.org/CPAN/authors/id/J/JH/JHI
      - name: Perlbal-1.80
        url:  http://search.cpan.org/CPAN/authors/id/D/DO/DORMANDO
      - name: Sys-Syscall-0.25
        url:  http://search.cpan.org/CPAN/authors/id/B/BR/BRADFITZ
      - name: IO-AIO-4.32
        url:  http://search.cpan.org/CPAN/authors/id/M/ML/MLEHMANN
      - name: common-sense-3.74
        url:  http://search.cpan.org/CPAN/authors/id/M/ML/MLEHMANN
      - name: Net-Netmask-1.9015
        url:  http://search.cpan.org/CPAN/authors/id/M/MU/MUIR/modules
      - name: Danga-Socket-1.61
        url:  http://www.cpan.org/modules/by-module/Danga

  tasks:
    #
    # These are older packages
    - name: Install required build dependiences
      yum:
        state: installed
        name: "{{ item }}"
      with_items:
        - perl-Danga-Socket
        - perl-BSD-Resource
        - perl-common-sense
        - perl-Danga-Socket
        - Perlbal

#rpm -ivh ../RPMS/noarch/perl-MogileFS-Utils-2.29-1.el6.noarch.rpm
#rpm -ivh ../RPMS/noarch/perl-MogileFS-Client-1.17-1.el6.noarch.rpm

    - name: Fetch mogilefs sources
      get_url:
        dest: "{{ build_dir }}/SOURCES/MogileFS-Server-{{ mogilefs_server_version }}.tar.gz"
        url: "https://github.com/mogilefs/MogileFS-Server/archive/{{ mogilefs_server_version }}.tar.gz"
      tags: fetch

    - name: Fetch mogilefs sources
      get_url:
        dest: "{{ build_dir }}/SOURCES/{{ item.name }}.tar.gz"
        url: "{{ item.url }}/{{ item.name }}.tar.gz"
      with_items:
        - "{{ perl_cpan_urls }}"
      tags: fetch

    - name: Copy Build Files to Sources
      copy:
        dest: "{{ build_dir }}/SOURCES/{{ item | basename }}"
        src: "{{ item }}"
      with_fileglob:
        - files/mogilefs/*
      tags: fetch

    - name: Build RPM for perl packages
      command: 'rpmbuild -ba --clean --buildroot=/tmp/rpmbuild --define "_topdir {{ build_dir }}" SPECS/{{ item }}'
      args:
        chdir: "{{ build_dir }}"
      with_items:
        - perl-BSD-Resource.spec
        - perl-common-sense.spec
        - perl-Net-Netmask.spec
        - perl-Sys-Syscall.spec
        - perl-IO-AIO.spec          ## This has dependency on rpms above.
        - perl-Danga-Socket.spec
        - Perlbal.spec
        - perl-MogileFs-Server.spec
      tags: build

    - name: List Builded RPMs
      debug: msg="Built RPM {{ item | basename }}"
      with_fileglob:
        - '{{ build_dir }}/RPMS/noarch/perl-MogileFS*.rpm'

    - name: Cleanup sources
      file:
        path: '{{ build_dir }}/SOURCES/mogilefs-{{ mogilefs_server_version }}.tar.gz'
        state: absent
      tags: cleanup

    - name: Cleanup Additional files
      file:
        path: '{{ build_dir }}/SOURCES/{{ item | basename }}'
        state: absent
      with_fileglob:
        - files/mogilefs/*
      tags: cleanup
