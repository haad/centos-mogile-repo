#!/usr/bin/ansible-playbook -i localhost,
---
- name: Create mogilefs rpm from source
  hosts: all
  gather_facts: False
  connection: local
  vars:
    - mogilefs_client_version: 1.17
    - build_dir: /vagrant/rpmbuild
  tasks:
    - name: Fetch mogilefs sources
      get_url:
        dest: "{{ build_dir }}/SOURCES/perl-MogileFS-Client-{{ mogilefs_client_version }}.tar.gz"
        url: "https://github.com/mogilefs/perl-MogileFS-Client/archive/{{ mogilefs_client_version }}.tar.gz"
      tags: fetch

    - name: Copy Build Files to Sources
      copy:
        dest: "{{ build_dir }}/SOURCES/{{ item | basename }}"
        src: "{{ item }}"
      with_fileglob:
        - files/mogilefs/*

    - command: ls files/mogilefs

    - name: Run RPM build
      command: 'rpmbuild -ba --clean --buildroot=/tmp/rpmbuild --define "_topdir {{ build_dir }}" SPECS/perl-MogileFs-Client.spec'
      args:
        chdir: "{{ build_dir }}"
      tags: build

    - name: List Builded RPMs
      debug: msg="Built RPM {{ item | basename }}"
      with_fileglob:
        - "{{ build_dir }}/RPMS/noarch/perl-MogileFS-Client*.rpm"

    - name: Cleanup sources
      file:
        path: "{{ build_dir }}/SOURCES/mogilefs-{{ mogilefs_client_version }}.tar.gz"
        state: absent
      tags: cleanup

    - name: Cleanup Additional files
      file:
        path: "{{ build_dir }}/SOURCES/{{ item | basename }}"
        state: absent
      with_fileglob:
        - files/mogilefs/*
      tags: cleanup
